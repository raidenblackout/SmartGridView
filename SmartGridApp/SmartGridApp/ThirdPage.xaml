<Page
    x:Class="SmartGridApp.ThirdPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:SmartGridApp"
    xmlns:controls="using:SmartGrid.Controls"
    xmlns:viewmodels="using:SmartGridApp"
    Background="White"
    NavigationCacheMode="Enabled">

    <Page.Resources>
        <local:InverseBoolConverter x:Key="InverseBoolConverter"/>
    </Page.Resources>

    <Grid Background="#F3F3F3">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Background="White" Padding="20,12" BorderBrush="#EEEEEE" BorderThickness="0,0,0,1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <StackPanel Orientation="Horizontal" Spacing="12">
                <Viewbox Height="24">
                    <SymbolIcon Symbol="List"/>
                </Viewbox>
                <TextBlock Text="Nested Virtualization Test" FontSize="18" FontWeight="SemiBold" VerticalAlignment="Center"/>
            </StackPanel>
            <Button Grid.Column="1" Content="Back" Click="OnBackClicked" Background="#444444" Foreground="White" CornerRadius="4" Padding="12,6"/>
        </Grid>

        <!-- Main ListView containing SmartGridViews -->
        <ListView Grid.Row="1" ItemsSource="{x:Bind ViewModel.Categories}" SelectionMode="None">
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0,0,0,20"/>
                </Style>
            </ListView.ItemContainerStyle>
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="local:CategoryViewModel">
                    <StackPanel Margin="0,10" Background="White" BorderBrush="#E0E0E0" BorderThickness="0,1">
                        <Grid Padding="20,15" Background="#FAFAFA">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="{x:Bind Name}" FontSize="18" FontWeight="Bold" Foreground="#333" VerticalAlignment="Center"/>
                                <Border Background="#E0E0E0" CornerRadius="10" Padding="8,2">
                                    <TextBlock Text="{x:Bind GridViewModel.CardCount, Mode=OneWay}" FontSize="12" Foreground="#555" FontWeight="SemiBold"/>
                                </Border>
                            </StackPanel>
                        </Grid>
                        
                        <!-- SmartGridView Nested Here -->
                        <!-- Binding VisibleItemsCount TwoWay to bubble up metrics -->
                        <controls:SmartGridView 
                            ItemsSource="{x:Bind GridViewModel.Cards}"
                            Background="Transparent"
                            Padding="10,10,10,20"
                            VisibleItemsCount="{x:Bind VisibleItemsCount, Mode=TwoWay}">
                            
                            <controls:SmartGridView.ItemTemplate>
                                <DataTemplate x:DataType="viewmodels:CardViewModel">
                                     <Grid Margin="6" x:Name="RootGrid" Background="White" BorderBrush="#DDDDDD" BorderThickness="1" CornerRadius="8"
                                           PointerPressed="OnCardSelected">
                                        
                                         <VisualStateManager.VisualStateGroups>
                                             <VisualStateGroup x:Name="SelectionStates">
                                                 <VisualState x:Name="Normal">
                                                     <VisualState.StateTriggers>
                                                         <StateTrigger IsActive="{x:Bind IsSelected, Converter={StaticResource InverseBoolConverter}, Mode=OneWay}"/>
                                                     </VisualState.StateTriggers>
                                                 </VisualState>
                                                 <VisualState x:Name="Selected">
                                                     <VisualState.StateTriggers>
                                                         <StateTrigger IsActive="{x:Bind IsSelected, Mode=OneWay}"/>
                                                     </VisualState.StateTriggers>
                                                     <VisualState.Setters>
                                                         <Setter Target="RootGrid.BorderBrush" Value="#007ACC"/>
                                                         <Setter Target="RootGrid.BorderThickness" Value="2"/>
                                                         <Setter Target="SelectionOverlay.Visibility" Value="Visible"/>
                                                     </VisualState.Setters>
                                                 </VisualState>
                                             </VisualStateGroup>
                                         </VisualStateManager.VisualStateGroups>

                                         <Grid>
                                             <Grid.RowDefinitions>
                                                 <RowDefinition Height="*"/>
                                                 <RowDefinition Height="Auto"/>
                                             </Grid.RowDefinitions>

                                             <!-- Image Content -->
                                             <Border Grid.Row="0" Background="#EEEEEE" CornerRadius="8,8,0,0">
                                                 <Grid>
                                                     <Image Source="{x:Bind ImageUrl1}" Stretch="UniformToFill"/>
                                                     <Border Background="#99000000" VerticalAlignment="Bottom" Height="36" Padding="12,0">
                                                         <TextBlock Text="{x:Bind Title}" Foreground="White" VerticalAlignment="Center" FontWeight="Bold"/>
                                                     </Border>
                                                     <Ellipse Width="44" Height="44" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" Stroke="White" StrokeThickness="2">
                                                         <Ellipse.Fill>
                                                             <ImageBrush ImageSource="{x:Bind ImageUrl2}" Stretch="UniformToFill"/>
                                                         </Ellipse.Fill>
                                                     </Ellipse>
                                                 </Grid>
                                             </Border>

                                             <!-- Info and Expand -->
                                             <Grid Grid.Row="1" Padding="12" Background="White" CornerRadius="0,0,8,8">
                                                 <StackPanel Spacing="2">
                                                     <TextBlock Text="{x:Bind Title}" FontSize="9" Opacity="0.4" TextTrimming="CharacterEllipsis"/>
                                                     <TextBlock Text="{x:Bind DisplayIndex}" FontSize="18" FontWeight="Black" Foreground="#333333"/>
                                                 </StackPanel>

                                                 <Border Background="#E53935" CornerRadius="4" Padding="12,6" 
                                                         HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                         PointerPressed="OnExpandClicked">
                                                     <TextBlock Text="EXPAND" Foreground="White" FontSize="11" FontWeight="Black"/>
                                                 </Border>
                                             </Grid>

                                             <Border x:Name="SelectionOverlay" Visibility="Collapsed" Background="#22007ACC" IsHitTestVisible="False"/>
                                         </Grid>
                                     </Grid>
                                </DataTemplate>
                            </controls:SmartGridView.ItemTemplate>
                        </controls:SmartGridView>
                    </StackPanel>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <!-- Unified Debug Bar -->
        <Border Grid.Row="2" Background="#1E1E1E" BorderBrush="#007ACC" BorderThickness="0,2,0,0" Padding="16,10">
            <Grid>
                 <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" Spacing="24">
                     <TextBlock Text="UNIFIED METRICS" VerticalAlignment="Center" Foreground="#007ACC" FontWeight="Bold" FontSize="12"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="28">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="Total Cards:" Foreground="#888888" FontSize="11" VerticalAlignment="Center"/>
                        <TextBlock Text="{x:Bind ViewModel.TotalCardCount, Mode=OneWay}" Foreground="White" FontWeight="Bold" FontSize="14"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="Total Visible:" Foreground="#888888" FontSize="11" VerticalAlignment="Center"/>
                        <TextBlock Text="{x:Bind ViewModel.TotalVisibleItems, Mode=OneWay}" Foreground="#00E5FF" FontWeight="Bold" FontSize="14"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Page>
